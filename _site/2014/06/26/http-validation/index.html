<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HTTP GET 方法的简单访问效验</title>
    <link rel="fluid-icon" href="/fluidicon.png" />
    <link rel="apple-touch-icon" sizes="57x57" href="/images/apple-touch-icon-114.png" />
    <link rel="apple-touch-icon" sizes="114x114" href="/images/apple-touch-icon-114.png" />
    <link rel="apple-touch-icon" sizes="72x72" href="/images/apple-touch-icon-144.png" />
    <link rel="apple-touch-icon" sizes="144x144" href="/images/apple-touch-icon-144.png" />
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico" />
    <link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <script src="//cdn.bootcss.com/jquery/1.11.3/jquery.min.js"></script>
    <script src="//cdn.bootcss.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="/css/style.css" />
    <script type="text/javascript">
        $(function () {
            $(window).scroll(function () {
                var scrolltop = $(this).scrollTop();
                if (scrolltop >= 100) {
                    $("#elevator_item").show();
                } else {
                    $("#elevator_item").hide();
                }
            });
            $("#elevator").click(function () {
                $("html,body").animate({ scrollTop: 0 }, 500);
            });
            $(".qr").hover(function () {
                $(".qr-popup").show();
            }, function () {
                $(".qr-popup").hide();
            });
        });
    </script>
  </head>
  <body>
    <div class="container menu">
      <ul>
  <li><a href="/">博客</a></li>
  <li>/</li>
  <li><a href="https://github.com/WangWenzhuang">GitHub</a></li>
  <li>/</li>
  <li><a href="/about/">关于</a></li>
</ul>
    </div>
    <div class="container content">
	<h4 class="post-title">HTTP GET 方法的简单访问效验</h4>
	<div class="post-title-line"></div>
	<div class="post-content">
	<h4 id="section">情景</h4>

<p>有这样一个获取数据的接口，此接口需要效验合法性，如果效验通过则返回正确数据。</p>

<h4 id="section-1">解决方案</h4>

<p>自定义一套签名算法，接口效验和请求者使用签名算法一致，并使用一致的 token。请求接口时将签名结果作为必要参数，接口收到请求效验合法性。</p>

<h4 id="section-2">代码</h4>

<p>公用的生成签名类</p>

<pre><code>public sealed class SignatureHelper
{
    /*
     * 必备参数：token、时间戳、随机数（9位）
     * 生成规则：对参数进行排序生成sha1哈希（不带符号）
     *
     * 2014/5/4
     *
     * 王文壮
     */
    /// &lt;summary&gt;
    /// 生成签名
    /// &lt;/summary&gt;
    public static string CreateSignature(Array array)
    {
        Array.Sort(array);
        string tmpStr = string.Empty;
        foreach (var tmp in array)
        {
            tmpStr += tmp;
        }
        return BitConverter.ToString(
            new SHA1CryptoServiceProvider().ComputeHash(
                new ASCIIEncoding().GetBytes(tmpStr)
            )
        ).Replace("-", string.Empty).ToLower();
    }

    /// &lt;summary&gt;
    /// 生成时间戳
    /// 规则：1970年1月1日至今的间隔秒数
    /// &lt;/summary&gt;
    public static string CreateTimestamp()
    {
        return ((int)DateTime.Now.Subtract(
            new DateTime(1970, 1, 1)).TotalSeconds
        ).ToString();
    }

    /// &lt;summary&gt;
    /// 创建9位随机数
    /// &lt;/summary&gt;
    public static string CreateRandomNumber()
    {
        return new Random().Next(100000000, 999999999).ToString();
    }

    /// &lt;summary&gt;
    /// 效验签名
    /// &lt;/summary&gt;
    public static bool CheckSignature(
        string token,
        string signature,
        string timestamp,
        string nonce)
    {
        string[] tempArr = { token, timestamp, nonce };
        var tmpStr = SignatureHelper.CreateSignature(tempArr);
        return tmpStr.Equals(signature);
    }
}
</code></pre>

<p>接口定义</p>

<pre><code>[HttpGet]
/*
 * signature：签名结果
 * timestamp：时间戳
 * nonce：随机字符串
 */
[HttpGet]
public string GetData(string signature, string timestamp, string nonce)
{
    var result = string.Empty;
    var token = "wangwenzhuang";
    if (!string.IsNullOrEmpty(signature)
        &amp;&amp; !string.IsNullOrEmpty(timestamp)
        &amp;&amp; !string.IsNullOrEmpty(nonce))
    {
        // 可以检测时间是否超时
        if (CheckTimeOut(timestamp))
        {
            // 检测签名的合法性
            if (SignatureHelper.CheckSignature(
                token,
                signature,
                timestamp, nonce))
            {
                result = "我是测试数据";
            }
        }
    }
    return result;
}

private bool CheckTimeOut(string timestamp)
{
    var result = default(bool);
    var now = int.Parse(SignatureHelper.CreateTimestamp());
    int time;
    if (int.TryParse(timestamp, out time))
    {
        // 超过30秒网页就过期
        if (now - time &gt;= 30)
        {
            result = false;
            LogHelper.Log("网页过期");
        }
        else
        {
            result = true;
        }
    }
    else
    {
        result = false;
    }
    return result;
}
</code></pre>

<p>请求</p>

<pre><code>public static string TestGetData()
{
    var timestamp = SignatureHelper.CreateTimestamp();
    var nonce = SignatureHelper.CreateRandomNumber();
    var signature = SignatureHelper.CreateSignature(
        new string[] { "wangwenzhuang", timestamp, nonce });
    var url = string.Format(
        "/GetData?signature={0}&amp;timestamp={1}&amp;nonce={2}",
        signature,
        timestamp,
        nonce);
    // 请求代码...
}
</code></pre>

	</div>
	<div class="post-time-line">
		分类：<span class="post-time-line-categories">技术</span>&nbsp;&nbsp;|&nbsp;&nbsp;
		<time datetime="2014-06-26">2014-06-26</time>
	</div>
	<!-- Duoshuo Comment BEGIN -->
<div class="ds-thread"></div>
<script type="text/javascript">
var duoshuoQuery = {short_name:"wangwenzhuang"};
(function() {
	var ds = document.createElement('script');
	ds.type = 'text/javascript';ds.async = true;
	ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
	ds.charset = 'UTF-8';
	(document.getElementsByTagName('head')[0] 
	 || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script>
<!-- Duoshuo Comment END -->
</div>
    <div class="container footer">
      <p>&copy;&nbsp;Copyright 2014 - 2015&nbsp;王文壮</p>
<p style="display:none"><script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_3431972'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s23.cnzz.com/stat.php%3Fid%3D3431972' type='text/javascript'%3E%3C/script%3E"));</script></p>
<div id="elevator_item">
    <a id="elevator" onclick="return false;" title="回到顶部"></a>
    <a class="qr"></a>
    <div class="qr-popup">
        <a class="code-link"><img class="code" src="/images/code.jpg" style="width:150px;height:150px;" /></a>
        <span>我的微信二维码</span>
        <div class="arr"></div>
    </div>
</div>

    </div>
  </body>
</html>
